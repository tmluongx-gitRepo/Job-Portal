name: Enforce PR Target Branch

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main

jobs:
  check-target:
    name: Block PRs to main
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      
      - name: Check PR source branch
        run: |
          SOURCE_BRANCH="${{ github.head_ref }}"
          
          if [ "$SOURCE_BRANCH" = "dev" ]; then
            echo "✅ Allowing dev → main PR (official release process)"
            exit 0
          fi
          
          echo "❌ ERROR: Direct pull requests to 'main' are not allowed!"
          echo ""
          echo "This project follows a dev → main workflow:"
          echo "  1. Create PRs targeting 'dev' branch"
          echo "  2. After approval and testing in dev, maintainers will merge dev → main"
          echo ""
          echo "Current PR: $SOURCE_BRANCH → main"
          echo ""
          echo "Please close this PR and create a new one targeting 'dev' instead."
          echo ""
          echo "To update this PR to target 'dev':"
          echo "  1. Go to the PR page"
          echo "  2. Click 'Edit' next to the title"
          echo "  3. Change base branch from 'main' to 'dev'"
          exit 1

      - name: Comment on PR
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: \`## ❌ Pull Request Target Error

            This PR is targeting the \\\`main\\\` branch from \\\`${{ github.head_ref }}\\\`, which is not allowed.

            ### Required Workflow
            All pull requests must target the \\\`dev\\\` branch first:
            1. ✅ Feature branches → \\\`dev\\\`
            2. ✅ After testing in \\\`dev\\\`, maintainers merge \\\`dev\\\` → \\\`main\\\`

            ### How to Fix
            You can change the target branch of this PR:
            1. Click the **"Edit"** button next to the PR title
            2. Change the **base branch** from \\\`main\\\` to \\\`dev\\\`
            3. The checks will automatically re-run

            Or close this PR and create a new one targeting \\\`dev\\\`.\`
            })
