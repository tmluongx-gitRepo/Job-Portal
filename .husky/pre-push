#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Job Portal Pre-Push Hook
# Runs comprehensive validation before pushing to remote

# Add common tool paths to PATH
export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$HOME/.bun/bin:$PATH"

set -e

echo "üöÄ Running pre-push validation..."

# Ensure GitHub CLI authentication if available
if command -v gh >/dev/null 2>&1; then
    gh auth status || {
        cat <<'EOF'
‚ùå GitHub CLI is not authenticated.
   Please run the following inside your devcontainer (once per machine):
     gh auth login --web --git-protocol ssh
     gh auth setup-git
EOF
        exit 1
    }
fi

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Prevent direct pushes to protected branches (main and dev)
if [ "$BRANCH" = "main" ]; then
    echo "‚ùå ERROR: Direct pushes to 'main' branch are not allowed!"
    echo "   The 'main' branch is protected and can only be updated via Pull Requests from 'dev'."
    echo ""
    echo "   Required workflow:"
    echo "   1. Create a feature branch: git checkout -b feature/your-feature-name"
    echo "   2. Push your feature branch: git push -u origin feature/your-feature-name"
    echo "   3. Create a Pull Request to 'dev' on GitHub"
    exit 1
fi

if [ "$BRANCH" = "dev" ]; then
    echo "‚ùå ERROR: Direct pushes to 'dev' branch are not allowed!"
    echo "   The 'dev' branch is protected and can only be updated via Pull Requests."
    echo ""
    echo "   Required workflow:"
    echo "   1. Create a feature branch: git checkout -b feature/your-feature-name"
    echo "   2. Push your feature branch: git push -u origin feature/your-feature-name"
    echo "   3. Create a Pull Request to 'dev' on GitHub"
    exit 1
fi

# Check for .env files being tracked
if git ls-files | grep -q "\.env$"; then
    echo "‚ùå ERROR: .env file is tracked in git!"
    echo "   Environment files should not be committed to version control."
    echo ""
    echo "   To fix this:"
    echo "   1. Remove from git: git rm --cached .env"
    echo "   2. Ensure .env is in .gitignore"
    echo "   3. Commit the change: git commit -m 'Remove .env from version control'"
    exit 1
fi

# Detect which parts of the codebase changed since last push
FRONTEND_CHANGED=$(git diff --name-only @{push}..HEAD 2>/dev/null | grep "^frontend/" || true)
BACKEND_CHANGED=$(git diff --name-only @{push}..HEAD 2>/dev/null | grep "^backend/" || true)

# If this is the first push, check all files
if [ -z "$FRONTEND_CHANGED" ] && [ -z "$BACKEND_CHANGED" ]; then
    FRONTEND_CHANGED=$(git ls-files | grep "^frontend/" || true)
    BACKEND_CHANGED=$(git ls-files | grep "^backend/" || true)
fi

# Frontend validation
if [ -n "$FRONTEND_CHANGED" ]; then
    echo "‚öõÔ∏è  Validating frontend..."

    if [ -d "frontend" ]; then
        cd frontend

        echo "  üìã Running ESLint..."
        bun run lint

        echo "  üî∑ Running TypeScript type check..."
        bun run type-check

        # Note: Production build is skipped in pre-push hook due to Next.js 15.5.6 + React 19 issue
        # with auto-generated error pages. ESLint + TypeScript checks are sufficient.
        # Build validation should happen in CI/CD pipeline.

        # Note: Add test command when tests are configured
        # echo "  üß™ Running tests..."
        # bun run test

        cd ..
    else
        echo "‚ö†Ô∏è  Warning: frontend/ directory not found (worktree?)"
        echo "   Skipping frontend validation..."
    fi
fi

# Backend validation
if [ -n "$BACKEND_CHANGED" ]; then
    echo "üêç Validating backend..."

    if [ -d "backend" ]; then
        cd backend

        # Ensure we have a working venv with Python 3.11
        if [ ! -f ".venv/bin/python" ] || [ ! -f ".venv/bin/ruff" ]; then
            echo "  üì¶ Setting up backend environment..."
            rm -rf .venv
            UV_LINK_MODE=copy uv venv --python python3.11 .venv
            UV_LINK_MODE=copy uv pip install --python .venv/bin/python -r requirements.txt
        fi

        echo "  üîß Running Ruff linting..."
        .venv/bin/ruff check .

        echo "  üìù Running Ruff formatting check..."
        .venv/bin/ruff format --check .

        echo "  üî∑ Running MyPy type check..."
        .venv/bin/mypy .

        # Set up test environment variables
        export REDIS_URL="redis://localhost:6379"
        export CHROMA_HOST="localhost"
        export CHROMA_PORT="8000"
        export MONGODB_URI="mongodb://localhost:27017"
        export MONGODB_DB_NAME="job_portal_test"

        echo "  üß™ Running pytest..."
        .venv/bin/pytest tests/ -v || {
            echo ""
            echo "‚ö†Ô∏è  Note: Tests failed or test suite not fully configured yet."
            echo "   This is a warning - push will continue."
            echo "   Please ensure tests are passing before merging to main."
        }

        cd ..
    else
        echo "‚ö†Ô∏è  Warning: backend/ directory not found (worktree?)"
        echo "   Skipping backend validation..."
    fi
fi

echo "‚úÖ Pre-push validation complete!"
echo "üéâ Ready to push to remote!"
