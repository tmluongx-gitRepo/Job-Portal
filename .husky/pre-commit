#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Job Portal Pre-Commit Hook
# Runs fast checks on staged files before allowing commit

set -e

echo "ğŸ” Running pre-commit checks..."

# Detect which parts of the codebase have staged changes
FRONTEND_CHANGED=$(git diff --cached --name-only | grep "^frontend/" || true)
BACKEND_CHANGED=$(git diff --cached --name-only | grep "^backend/" || true)

# Run lint-staged for file-level formatting and linting
echo "âœ¨ Running lint-staged..."
cd frontend && npx lint-staged && cd ..

# Frontend checks (if frontend files are staged)
if [ -n "$FRONTEND_CHANGED" ]; then
    echo "âš›ï¸  Checking frontend code..."

    if [ -d "frontend" ]; then
        cd frontend

        echo "  ğŸ“‹ Running ESLint..."
        bun run lint

        echo "  ğŸ”· Running TypeScript type check..."
        bun run type-check

        cd ..
    else
        echo "âš ï¸  Warning: frontend/ directory not found (worktree?)"
    fi
fi

# Backend checks (if backend files are staged)
if [ -n "$BACKEND_CHANGED" ]; then
    echo "ğŸ Checking backend code..."

    if [ -d "backend" ]; then
        cd backend

        echo "  ğŸ”§ Running Ruff linting..."
        uv run ruff check .

        echo "  ğŸ“ Running Ruff formatting check..."
        uv run ruff format --check .

        echo "  ğŸ”· Running MyPy type check..."
        uv run mypy app/ --config-file=pyproject.toml

        cd ..
    else
        echo "âš ï¸  Warning: backend/ directory not found (worktree?)"
    fi
fi

echo "âœ… Pre-commit checks passed!"
